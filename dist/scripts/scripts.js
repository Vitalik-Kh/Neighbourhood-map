var map,geocoder,initMap,infoWindow;(app=app||{}).model={neighbourhood:[{title:"Trinity Shopping Center",address:"27 Albion St, Leeds LS1 5ER",type:"Shopping center"},{title:"Co-opperative Food",address:"Co-op Food, 44 New York St, Leeds LS2 7DY",type:"Supermarket"},{title:"John Lewis",address:"Victoria Gate, Harewood St, Leeds LS2 7AR",type:"Shopping center"},{title:"Royal Armoories Museum",address:"Royal Armoories Museum, Armouries Dr, Leeds LS10 1LT",type:"Museum"},{title:"North Star Coffee Roasters",address:"North Star Coffee Roasters, 33 Boulevard Rise, Leeds LS10 1PZ",type:"Coffee shop"},{title:"Tesco Express",address:"Tesco Express, 2 the Blvd, Leeds LS10 1PZ",type:"Supermarket"},{title:"The Light",address:"The Light, The Headrow, Leeds LS1 8TL",type:"Shopping center, Cinema"},{title:"Leeds Railway Station",address:"New Station St, Leeds LS1 4DY",type:"Train station"},{title:"City Bus Station",address:"Leeds City Bus Station, Dyer St, Leeds LS2 7LA",type:"Bus station"},{title:"Crown Point Shopping Park",address:"Junction St, Leeds LS10 1ET",type:"Shopping park"},{title:"Morrisons",address:"Morrisons, Merrion Centre, 43 Merrion Center, Leeds LS2 8PL",type:"Supermarket"}],Place:function(e){this.title=ko.observable(e.title),this.address=ko.observable(e.address)},toDoubleDigit:function(e){return e<10&&(e="0"+e),e},fourSquareSearch:function(e){var o="NTS03D13RWM5UXOCD5QTQ5RHASCPX1VWJLKCLEQTXGPY130G",t="FJEZ4WHAINE42GT54SVTLMXWTW0BZVI0ECBYCQPI5JGKSYUA",i=new Date,a=i.getFullYear()+""+this.toDoubleDigit(i.getMonth()+1)+this.toDoubleDigit(i.getDate()),s="https://api.foursquare.com/v2/venues/search";s+="?"+$.param({ll:e.geoCode.lat()+","+e.geoCode.lng(),address:e.address,intent:"match",name:e.title,client_id:o,client_secret:t,v:a}),$.ajax({url:s,method:"GET"}).done(function(i){app.model.fourSquareVenue(i,o,t,e)}).fail(function(e){throw e})},fourSquareVenue:function(e,o,t,i){if(e.response.venues[0]){var a="https://api.foursquare.com/v2/venues/";a+=e.response.venues[0].id+"?"+$.param({client_id:o,client_secret:t,v:"20180219"}),$.ajax({url:a,method:"GET"}).done(function(e){app.model.addInfoBoxData(e,i)}).fail(function(e){throw e})}},addInfoBoxData:function(e,o){var t,i=e.response.venue,a={title:o.title,imgUrl:i.bestPhoto.prefix+"500x300"+i.bestPhoto.suffix,phone:i.contact.formattedPhone,address:o.address,website:i.url,rating:i.rating,hours:function(){if(i.hours){var e=[],o=i.hours.timeframes;return o.forEach(function(o){e.push({days:o.days,open:o.open[0].renderedTime})}),e}}()};o.info=(t="",t+='<div class="infoBox">',a.imgUrl&&(t+='<img src="'+a.imgUrl+'" width="350">'),t+="<h1>"+a.title+"</h1>",t+=a.address+"<br>",a.phone&&(t+="Phone: "+a.phone+"<br>"),t+="Rating: "+a.rating+"<br>",a.website&&(t+='<a href="'+a.website+'" target="_blank">Website</a><br>'),a.hours&&(t+="<p><b>Open hours:</b><br>",a.hours.forEach(function(e){t+=e.days+": "+e.open+"<br>"}),t+="</p>"),t+="</div>")}},initMap=function(){geocoder=new google.maps.Geocoder;var e={lat:53.799,lng:-1.548},o=document.getElementById("map-container");map=new google.maps.Map(o,{center:e,zoom:14}),google.maps.event.addDomListener(window,"resize",function(){map.setCenter(e)}),infoWindow=new google.maps.InfoWindow,app.mapView.createMarkersFrom(app.listView.placesList())},(app=app||{}).mapView={markers:[],createMarkersFrom:function(e){this.clearMarkers(),e.forEach(function(e){geocoder.geocode({address:e.address},function(o,t){if("OK"!=t)throw"Geocoding of "+e.title+" was not successful because: "+t;app.mapView.addMarker(e,o[0].geometry.location),e.geoCode=o[0].geometry.location,app.model.fourSquareSearch(e)})})},addMarker:function(e,o){var t=new google.maps.Marker({position:o,map:map,animation:google.maps.Animation.DROP,title:e.title});this.markers.push(t),t.addListener("click",function(){app.mapView.showInfoWindow(e,t)})},clearMarkers:function(){this.markers.forEach(function(e){e.setMap(null)}),markers=[]},showInfoWindow:function(e,o){infoWindow.setContent(e.info||"No information"),o?infoWindow.open(map,o):(infoWindow.setPosition(e.geoCode),infoWindow.open(map))}},(app=app||{}).listView={init:function(){this.populatePlasesListFrom(app.model.neighbourhood),this.fuse=new Fuse(app.model.neighbourhood,{keys:["title","type"],threshold:.2,tokenize:!0,matchAllTokens:!0})},populatePlasesListFrom:function(e){var o=this;o.placesList.removeAll(),e.forEach(function(e){o.placesList.push(e)})},placesList:ko.observableArray(),searchInput:ko.observable(""),fuse:"",search:function(e){var o=this.fuse.search(this.searchInput());""==this.searchInput()?this.populatePlasesListFrom(app.model.neighbourhood):this.populatePlasesListFrom(o)},clearSearch:function(){this.searchInput(""),this.populatePlasesListFrom(app.model.neighbourhood)},showInfoWindow:function(e){var o=!1;app.mapView.markers.forEach(function(t){t.position==e.geoCode&&(app.mapView.showInfoWindow(e,t),o=!0)}),!1===o&&app.mapView.showInfoWindow(e)},toggleSearchMenu:function(){$("#search-icon").toggleClass("show-search-icon"),$("#places-container").toggleClass("show-list")}};var app=app||{};ko.applyBindings(app.listView),app.listView.init();